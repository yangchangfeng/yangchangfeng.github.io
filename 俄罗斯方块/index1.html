<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>俄罗斯方块</title>
    <style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    .matrix {
        position: relative;
        left: 120px;
        top: 80px;
        background: #9ead86;
        width: 350px;
    }

    .matrix p {
        width: 220px;
        height: 22px;
    }

    b,
    b:after {
        display: block;
    }

    b.c {
        border-color: #000;
    }

    b.c:after {
        background: #000;
    }

    b {
        width: 20px;
        height: 20px;
        padding: 2px;
        border: 2px solid rgba(0, 0, 0, .15);
        margin: 0 2px 2px 0;
        float: left;
    }

    b:after {
        content: "";
        width: 12px;
        height: 12px;
        background: #879372;
        overflow: hidden;
    }
    </style>
</head>

<body>
    <div class="matrix">
        <p>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
        </p>
        <p>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
        </p>
        <p>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
        </p>
        <p>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
        </p>
        <p>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
        </p>
        <p>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
        </p>
        <p>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
        </p>
        <p>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
        </p>
        <p>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
        </p>
        <p>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
        </p>
        <p>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
        </p>
        <p>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
        </p>
        <p>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
        </p>
        <p>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
        </p>
        <p>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
        </p>
        <p>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
        </p>
        <p>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
        </p>
        <p>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
        </p>
        <p>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
        </p>
        <p>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
            <b></b>
        </p>
    </div>
</body>
<script>
var bgc = new Array(20).fill(0).map(it => new Array(10).fill(0))
//stick是用来判断 那些部分可以move和rotate的
var stick = new Array(20).fill(0).map(it => new Array(10).fill(0))

function draw(bgc) {
    // console.log('paint')
    let painter = document.querySelectorAll('b')
    for (let i = 0; i < bgc.length; i++) {
        for (let j = 0; j < bgc[i].length; j++) {
            if (bgc[i][j] == 1) {
                painter[i * 10 + j].classList.add('c')
            } else {
                painter[i * 10 + j].classList.remove('c')
            }
        }
    }
}
draw(bgc)

function drop(ary) {
    brickBuilder()
    var lineary = []
    var dropId = setInterval(function() {
        for (let i = ary.length - 1; i >= 0; i--) {
            for (let j = 0; j < ary[i].length; j++) {
                if (ary[i][j] === 1 && stick[i][j] === 0) {
                    if (i === ary.length - 1 || stick[i + 1][j] == 1) {
                        stick = JSON.parse(JSON.stringify(bgc))
                        clearInterval(dropId);
                        // console.log('下一轮')
                        return drop(bgc)
                    } else {
                        lineary.push([i, j])
                    }
                }
            }
        }
        lineary.forEach(item => {
            bgc[item[0] + 1][item[1]] = 1;
            bgc[item[0]][item[1]] = 0;
        })
        lineary = []
        draw(ary)
    }, 600)
}
drop(bgc)

function brickBuilder() {
    //砖块一共有7种
    var mark = Math.floor(Math.random() * 7)
    var storage = [
        [
            [0, 4],
            [0, 5],
            [1, 4],
            [1, 5]
        ],
        [
            [0, 3],
            [0, 4],
            [0, 5],
            [0, 6]
        ],
        [
            [1, 4],
            [1, 5],
            [1, 6],
            [0, 5]
        ],
        [
            [0, 4],
            [0, 5],
            [1, 5],
            [1, 6]
        ],
        [
            [1, 4],
            [1, 5],
            [0, 5],
            [0, 6]
        ],
        [
            [1, 4],
            [1, 5],
            [1, 6],
            [0, 6]
        ],
        [
            [0, 4],
            [1, 4],
            [1, 5],
            [1, 6]
        ]
    ]
    storage[mark].forEach(item => {
        bgc[item[0]][item[1]] = 1
    })
    draw(bgc)
}

function moveBottom() {
    console.log('向下向下')
    console.log(flag)
    let ary = []
    let point = 0
    for (let i = bgc.length - 1; i >= 0; i--) {
        for (let j = 0; j < bgc[i].length; j++) {
            if (bgc[i][j] == 1 && stick[i][j] != 1) {
                ary.push([i, j])
            }
        }
    }
    console.log(JSON.stringify(ary))
    let minrange = minRange(ary)
    // console.log('最小值', minrange, JSON.stringify(stick))
    if (minrange > 2) point = 3;
    else point = minrange;
    if (point !== 1) flag = false;
    for (let i = 0; i < point - 1; i++) {
        setTimeout(() => {
            ary.forEach(item => {
                bgc[item[0] + 1 + i][item[1]] = 1;
                bgc[item[0] + i][item[1]] = 0;
                if (i == point - 2) flag = true;
                console.log(flag)
                draw(bgc)
            })
        }, i * 40)
    }
}
// var test = throttle(moveBottom, 80)

function minRange(ary) {
    var storage = []
    ary.forEach(item => {
        let flag = true
        for (let i = item[0]; i <= bgc.length - 1; i++) {
            if (stick[i][item[1]] === 1) {
                storage.push(i - item[0])
                flag = false
                break;
            }
        }
        if (flag) {
            storage.push(bgc.length - item[0])
        }
    })
    console.log('取值范围', storage)
    return Math.min(...storage)
}
//向下加速时有若干setTimeout异步事件，这时候按左右键会穿插进异步里造成积木分裂，设置flag来判断异步是否完成
var flag = true

function movie() {
    addEventListener('keydown', function(event) {
        console.log(event.keyCode)
        event.preventDefault();
        //向左移动
        if (event.keyCode === 37 && flag) {
            console.log(flag)
            let ary = []
            for (let i = 0; i < bgc.length; i++) {
                for (let j = 0; j < bgc[i].length; j++) {
                    if (bgc[i][j] == 1 && stick[i][j] != 1) {
                        ary.push([i, j])
                    }
                }
            }
            if (ary.every(item =>
                    item[1] !== 0
                ) && ary.every(item => stick[item[0]][item[1] - 1] !== 1)) {
                //当没碰到墙壁时and左边没有积木时
                ary.forEach(item => {
                    bgc[item[0]][item[1]] = 0;
                    bgc[item[0]][item[1] - 1] = 1;
                })
            }
            draw(bgc)
        }
        //向右移动
        else if (event.keyCode === 39 && flag) {
            let ary = []
            for (let i = 0; i < bgc.length; i++) {
                for (let j = bgc[i].length - 1; j >= 0; j--) {
                    if (bgc[i][j] == 1 && stick[i][j] != 1) {
                        ary.push([i, j])
                    }
                }
            }
            if (ary.every(item => item[1] !== bgc[0].length - 1) && ary.every(item => stick[item[0]][item[1] + 1] !== 1)) {
                ary.forEach(item => {
                    bgc[item[0]][item[1]] = 0;
                    bgc[item[0]][item[1] + 1] = 1
                })
            }
            draw(bgc)
        }
        //向下加速
        else if (event.keyCode === 40&&flag) {
            moveBottom()
        }
        //空格键瞬间补位完成
        else if (event.keyCode === 32) {
            let ary = []
            for (let i = bgc.length - 1; i >= 0; i--) {
                for (let j = 0; j < bgc[i].length; j++) {
                    if (bgc[i][j] == 1 && stick[i][j] != 1) {
                        ary.push([i, j])
                    }
                }
            }
            var l=minRange(ary)-1
            ary.forEach(item=>{
            	bgc[item[0]][item[1]]=0;
            	bgc[item[0]+l][item[1]]=1;
            })
            draw(bgc)
        }
        //旋转
        else if (event.keyCode === 38) {
            let ary = []
            for (let i = 0; i < bgc.length; i++) {
                for (let j = 0; j < bgc[i].length; j++) {
                    if (bgc[i][j] == 1) {
                        ary.push([i, j])
                    }
                }
            }
            if (ary[1][1] > 0 && ary[1][1] < 8) {
                //由—— 变 |
                if (ary[0][0] == ary[1][0]) {
                    bgc[ary[0][0]][ary[0][1]] = 0;
                    bgc[ary[2][0]][ary[2][1]] = 0;
                    bgc[ary[3][0]][ary[3][1]] = 0;
                    bgc[ary[1][0] - 1][ary[1][1]] = 1;
                    bgc[ary[1][0] + 1][ary[1][1]] = 1;
                    bgc[ary[1][0] + 2][ary[1][1]] = 1;
                    draw(bgc)
                }
                // 由 | 变 —— 
                else {
                    bgc[ary[0][0]][ary[0][1]] = 0;
                    bgc[ary[2][0]][ary[2][1]] = 0;
                    bgc[ary[3][0]][ary[3][1]] = 0;
                    bgc[ary[1][0]][ary[1][1] - 1] = 1;
                    bgc[ary[1][0]][ary[1][1] + 1] = 1;
                    bgc[ary[1][0]][ary[1][1] + 2] = 1;
                    draw(bgc)
                }
            }
        }
    })
}
movie()

function throttle(fn, gap) {
    var lastRunTime = -Infinity
    var context = this
    return function(...args) {
        var now = Date.now()
        if (now - lastRunTime > gap) {
            fn.apply(context, args)
            lastRunTime = now
        }
    }
}
</script>

</html>